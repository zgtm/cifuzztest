name: fuzz_with_cifuzz
on: [push]
jobs:
  fuzz:
    runs-on: ubuntu-latest

    permissions:
      # Please comment-out the ones you don't need!
    
      # Required to Upload findings to Github code scanning (SARIF report)
      security-events: write
      
      # Required to commit findings to repository
      # contents: write
      
    steps:
    
      - name: Install clang, llvm & lcov
        run: |
          sudo apt update
          sudo apt install cmake clang llvm lcov
          sudo apt install libclang-rt-dev || true # required on on ubuntu 24.04

      - name: Checkout repository
        uses: "actions/checkout@v4"
        
      - name: Install cifuzz
        uses: "zgtm/cifuzztest/install-cifuzz@HEAD"
        with:
          version: 3.12.0
          download-token: ${{ secrets.CIFUZZ_DOWNLOAD_TOKEN }}
        
      - name: Run fuzzing
        uses: "zgtm/cifuzztest/run-fuzzing@HEAD"
        with:
          duration: 15s
        
      - name: Upload code-scanning report
        uses: "zgtm/cifuzztest/upload-code-scanning-report@HEAD"
          
      #- name: Commit findings and corpus to repository
      #  run: |
      #    git config --global user.name 'Github Action'
      #    git config --global user.email 'zgtm@users.noreply.github.com'
      #    git add .cifuzz-findings
      #    git add .cifuzz-corpus
      #    git commit -m "Automated check-in of cifuzz findings"
      #    git push
